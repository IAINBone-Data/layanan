<script defer>
document.addEventListener('DOMContentLoaded', function() {
    const user = JSON.parse(sessionStorage.getItem('currentUser'));

    // --- MODAL SELECTORS ---
    const detailPengaduanModal = document.getElementById('detailPengaduanModal');
    const closeDetailPengaduanModalBtn = document.getElementById('closeDetailPengaduanModalBtn');
    const balasanPengaduanModal = document.getElementById('balasanPengaduanModal');
    const closeBalasanPengaduanModalBtn = document.getElementById('closeBalasanPengaduanModalBtn');
    const balasanPengaduanForm = document.getElementById('balasanPengaduanForm');

    if(closeDetailPengaduanModalBtn) closeDetailPengaduanModalBtn.addEventListener('click', () => detailPengaduanModal.classList.add('hidden'));
    if(closeBalasanPengaduanModalBtn) closeBalasanPengaduanModalBtn.addEventListener('click', () => balasanPengaduanModal.classList.add('hidden'));
    if(balasanPengaduanForm) balasanPengaduanForm.addEventListener('submit', handleSaveBalasan);

    window.handleViewPengaduanDetail = function(rowIndex) {
        const detailContent = document.getElementById('detailPengaduanContent');
        detailContent.innerHTML = '<div class="flex justify-center items-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-brand-green"></i></div>';
        detailPengaduanModal.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(data => {
                if (data.error) {
                    detailContent.innerHTML = `<p class="text-red-500">${data.error}</p>`;
                    return;
                }
                let contentHtml = '<dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">';
                for(const key in data) {
                    if (data.hasOwnProperty(key)) {
                        contentHtml += `
                            <div class="border-b pb-2">
                                <dt class="text-sm font-medium text-gray-500">${key}</dt>
                                <dd class="mt-1 text-sm text-gray-900">${data[key] || '-'}</dd>
                            </div>
                        `;
                    }
                }
                contentHtml += '</dl>';
                detailContent.innerHTML = contentHtml;
            })
            .withFailureHandler(err => {
                detailContent.innerHTML = `<p class="text-red-500">Gagal memuat detail: ${err.message}</p>`;
            })
            .getPengaduanDetail(rowIndex, user);
    }

    window.handleBalasPengaduan = function(rowIndex) {
        balasanPengaduanForm.reset();
        balasanPengaduanForm.querySelector('#rowIndex').value = rowIndex;
        balasanPengaduanModal.classList.remove('hidden');
    }

    function handleSaveBalasan(e) {
        e.preventDefault();
        const saveBtn = e.target.querySelector('button[type="submit"]');
        saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Menyimpan...`;
        saveBtn.disabled = true;

        const formData = new FormData(e.target);
        const dataObject = Object.fromEntries(formData.entries());
        
        google.script.run
            .withSuccessHandler(response => {
                if(response.success) {
                    showNotificationModal('Berhasil', 'Balasan berhasil disimpan.', 'success');
                    balasanPengaduanModal.classList.add('hidden');
                    document.dispatchEvent(new Event('reload-data'));
                } else {
                    showNotificationModal('Gagal', `Gagal menyimpan: ${response.message}`, 'error');
                }
                saveBtn.innerHTML = 'Simpan';
                saveBtn.disabled = false;
            })
            .withFailureHandler(err => {
                showNotificationModal('Error', `Terjadi kesalahan: ${err.message}`, 'error');
                saveBtn.innerHTML = 'Simpan';
                saveBtn.disabled = false;
            })
            .updatePengaduan(dataObject);
    }

    window.handleDeletePengaduan = function(rowIndex) {
        showConfirmationModal(
            'Konfirmasi Hapus',
            'Apakah Anda yakin ingin menghapus data pengaduan ini?',
            'Ya, Hapus',
            () => {
                google.script.run
                    .withSuccessHandler(response => {
                        if(response.success) {
                            showNotificationModal('Berhasil', 'Data berhasil dihapus.', 'success');
                            document.dispatchEvent(new Event('reload-data'));
                        } else {
                             showNotificationModal('Gagal', `Gagal menghapus: ${response.message}`, 'error');
                        }
                    })
                    .withFailureHandler(err => showNotificationModal('Gagal', 'Gagal menghapus data: ' + err.message, 'error'))
                    .deletePengaduan(rowIndex);
            }
        );
    }

    window.renderPengaduanPage = function(headers, data) {
        const headersContainer = document.getElementById('pengaduan-headers');
        const bodyContainer = document.getElementById('pengaduan-body');
        const cardsContainer = document.getElementById('pengaduan-cards');
        const exportBtn = document.getElementById('exportPengaduanBtn');
        headersContainer.innerHTML = '';
        bodyContainer.innerHTML = '';
        cardsContainer.innerHTML = '';
        window.pengaduanHeaders = headers;
        if (!headers || headers.length === 0) return;
       
        if (user && user.peran === 'Pusat') {
            exportBtn.classList.remove('hidden');
        }
        const columnsToShow = ['IDPermohonan', 'Nama Pelapor', 'Jenis', 'Judul Laporan', 'Rahasia', 'Status'];
       
        let tableHeadersHtml = columnsToShow.map(header =>
            `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header.replace('IDPermohonan', 'ID')}</th>`
        ).join('');
        tableHeadersHtml += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>`;
        headersContainer.innerHTML = tableHeadersHtml;
        if (!data || data.length === 0) {
            const colspan = columnsToShow.length + 1;
            bodyContainer.innerHTML = `<tr><td colspan="${colspan}" class="p-4 text-center text-gray-500">Tidak ada data pengaduan.</td></tr>`;
            cardsContainer.innerHTML = `<div class="p-4 text-center text-gray-500">Tidak ada data pengaduan.</div>`;
            return;
        }

        let allRowsHtml = '';
        let allCardsHtml = '';
        data.forEach((item, index) => {
            let rowHtml = '<tr>';
            columnsToShow.forEach(header => {
                let cellContent = item[header] || '';
                if (header === 'Rahasia' || header === 'Anonim') {
                    cellContent = cellContent === true ? '<i class="fas fa-check-circle text-green-500"></i>' : '';
                }
                rowHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${cellContent}</td>`;
            });
            rowHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="window.handleViewPengaduanDetail(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200" title="Lihat Detail"><i class="fas fa-eye"></i></button>
                            <button onclick="window.handleBalasPengaduan(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200" title="Balas/Tindak Lanjut"><i class="fas fa-comment-dots"></i></button>
                            <button onclick="window.handleDeletePengaduan(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-red-100 text-red-600 rounded-md hover:bg-red-200" title="Hapus"><i class="fas fa-trash-alt"></i></button>
                        </td>`;
            rowHtml += '</tr>';
            allRowsHtml += rowHtml;

            let cardHtml = `<div class="bg-white rounded-lg shadow p-4 space-y-3">`;
            columnsToShow.forEach(header => {
                 let cellContent = item[header] || '-';
                 if (header === 'Rahasia' || header === 'Anonim') {
                    cellContent = item[header] === true ? 'Ya' : 'Tidak';
                }
                cardHtml += `<div>
                               <p class="text-xs text-gray-500 uppercase">${header.replace('IDPermohonan', 'ID')}</p>
                               <div class="text-sm font-medium text-gray-800">${cellContent}</div>
                             </div>`;
            });
            cardHtml += `<div class="border-t pt-3 flex justify-end space-x-2">
                           <button onclick="window.handleViewPengaduanDetail(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200" title="Lihat Detail"><i class="fas fa-eye"></i></button>
                           <button onclick="window.handleBalasPengaduan(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200" title="Balas/Tindak Lanjut"><i class="fas fa-comment-dots"></i></button>
                           <button onclick="window.handleDeletePengaduan(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-red-100 text-red-600 rounded-md hover:bg-red-200" title="Hapus"><i class="fas fa-trash-alt"></i></button>
                         </div>`;
            cardHtml += '</div>';
            allCardsHtml += cardHtml;
        });

        bodyContainer.innerHTML = allRowsHtml;
        cardsContainer.innerHTML = allCardsHtml;
    };

    const exportBtn = document.getElementById('exportPengaduanBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', () => {
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengekspor...';
            exportBtn.disabled = true;
            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        const blob = new Blob([response.csvData], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement("a");
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", `Data_Pengaduan_${new Date().toLocaleDateString('id-ID')}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotificationModal('Berhasil', 'Data berhasil diekspor.', 'success');
                    } else {
                        showNotificationModal('Gagal', 'Gagal mengekspor data: ' + response.message, 'error');
                    }
                    exportBtn.innerHTML = '<i class="fas fa-file-excel"></i> Ekspor ke Excel';
                    exportBtn.disabled = false;
                })
                .withFailureHandler(err => {
                    showNotificationModal('Error', 'Terjadi kesalahan saat mengekspor: ' + err.message, 'error');
                    exportBtn.innerHTML = '<i class="fas fa-file-excel"></i> Ekspor ke Excel';
                    exportBtn.disabled = false;
                })
                .exportPengaduanData();
        });
    }
});
</script>

