<script defer>
// --- NOTIFICATION MODAL FUNCTION ---
function showNotificationModal(title, message, type = 'info') {
    const modal = document.getElementById('notificationModal');
    const iconContainer = document.getElementById('notificationIcon');
    const titleEl = document.getElementById('notificationTitle');
    const messageEl = document.getElementById('notificationMessage');
    const closeBtn = document.getElementById('closeNotificationBtn');
    if (!modal) return;
    titleEl.textContent = title;
    messageEl.textContent = message;
    iconContainer.className = 'mx-auto mb-4 w-16 h-16 flex items-center justify-center rounded-full text-4xl';
    if (type === 'success') {
        iconContainer.classList.add('bg-green-100', 'text-green-600');
        iconContainer.innerHTML = `<i class="fas fa-check-circle"></i>`;
    } else if (type === 'error') {
        iconContainer.classList.add('bg-red-100', 'text-red-600');
        iconContainer.innerHTML = `<i class="fas fa-times-circle"></i>`;
    } else {
        iconContainer.classList.add('bg-blue-100', 'text-blue-600');
        iconContainer.innerHTML = `<i class="fas fa-info-circle"></i>`;
    }
    modal.classList.remove('hidden');
    closeBtn.onclick = () => modal.classList.add('hidden');
}
// --- NEW CONFIRMATION MODAL FUNCTION ---
function showConfirmationModal(title, message, confirmText = 'Hapus', onConfirm = () => {}) {
    const modal = document.getElementById('confirmationModal');
    if (!modal) return;
    modal.querySelector('#confirmationTitle').textContent = title;
    modal.querySelector('#confirmationMessage').textContent = message;
   
    const confirmBtn = modal.querySelector('#confirmBtn');
    const cancelBtn = modal.querySelector('#cancelConfirmBtn');
    confirmBtn.textContent = confirmText;
    const hideModal = () => modal.classList.add('hidden');
   
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
   
    newCancelBtn.addEventListener('click', hideModal);
    newConfirmBtn.addEventListener('click', () => {
        hideModal();
        onConfirm();
    });
    modal.classList.remove('hidden');
}
// --- GLOBAL HANDLERS ---
window.handleEditPublikData = function(rowIndex, data) {
    document.getElementById('publikModalTitle').textContent = 'Edit Data Publik';
    const form = document.getElementById('publikDataForm');
    form.reset();
   
    let formHtml = `<input type="hidden" id="rowIndex" name="rowIndex" value="${rowIndex}">`;
    let fieldsHtml = '';
    window.publikHeaders.forEach(header => {
        const value = data[header] || '';
        const safeHeaderId = header.replace(/\s+/g, '-');
        if (header.toLowerCase() === 'jenis') {
            const options = ['Info', 'Pin', 'Link', 'Footer Link'];
            let optionsHtml = options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('');
            fieldsHtml += `
                <div>
                    <label for="${safeHeaderId}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <select name="${header}" id="${safeHeaderId}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">${optionsHtml}</select>
                </div>
            `;
        } else if (header.toLowerCase() === 'warna') {
            const softColors = ['#e0f2fe', '#fef9c3', '#dcfce7', '#f3e8ff', '#ffe4e6'];
            const vibrantColors = ['#3b82f6', '#f59e0b', '#22c55e', '#a855f7', '#ef4444'];
           
            const createColorOptions = (colors, currentValue) => {
                return colors.map(color => `
                    <label class="cursor-pointer">
                        <input type="radio" name="Warna" value="${color}" class="sr-only" ${currentValue.toLowerCase() === color ? 'checked' : ''}>
                        <span class="block w-8 h-8 rounded-full border-2 border-transparent ring-2 ring-offset-1" style="background-color: ${color};"></span>
                    </label>
                `).join('');
            };
            fieldsHtml += `
                <div class="md:col-span-2">
                    <label for="${safeHeaderId}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <div class="mt-2 space-y-3" id="color-palette">
                        <div class="flex items-center gap-3">${createColorOptions(softColors, value)}</div>
                        <div class="flex items-center gap-3 mt-3">${createColorOptions(vibrantColors, value)}</div>
                    </div>
                </div>`;
        } else {
            fieldsHtml += `
                <div>
                    <label for="${safeHeaderId}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <input type="text" name="${header}" id="${safeHeaderId}" value="${String(value).replace(/"/g, '&quot;')}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            `;
        }
    });
    form.innerHTML = formHtml + `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldsHtml}</div>`;
   
    const palette = form.querySelector('#color-palette');
    if (palette) {
        palette.addEventListener('change', (e) => {
            if (e.target.type === 'radio') {
                palette.querySelectorAll('span').forEach(span => span.classList.remove('ring-blue-500'));
                e.target.nextElementSibling.classList.add('ring-blue-500');
            }
        });
        const checkedRadio = palette.querySelector('input[type="radio"]:checked');
        if (checkedRadio) {
            checkedRadio.nextElementSibling.classList.add('ring-blue-500');
        }
    }
    document.getElementById('publikDataModal').classList.remove('hidden');
}
window.handleDeletePublikData = function(rowIndex) {
    showConfirmationModal(
        'Konfirmasi Hapus',
        'Apakah Anda yakin ingin menghapus data publik ini?',
        'Ya, Hapus',
        () => {
            google.script.run
                .withSuccessHandler(() => {
                    showNotificationModal('Berhasil', 'Data berhasil dihapus.', 'success');
                    google.script.run.clearCache();
                    document.dispatchEvent(new Event('reload-data'));
                })
                .withFailureHandler(err => showNotificationModal('Gagal', 'Gagal menghapus data: ' + err.message, 'error'))
                .deleteInfoData(rowIndex);
        }
    );
}

/**
 * --- DIPERBARUI ---
 * Fungsi ini sekarang menerima idPermohonan, bukan rowIndex.
 */
window.handleEditPeminjamanData = function(idPermohonan, data) {
    document.getElementById('peminjamanModalTitle').textContent = 'Edit Data Peminjaman';
    const form = document.getElementById('peminjamanDataForm');
    form.reset();
   
    // Simpan IDPermohonan di hidden input, bukan rowIndex
    let formHtml = `<input type="hidden" id="idPermohonan" name="idPermohonan" value="${idPermohonan}">`;
    const formFieldsWrapper = document.createElement('div');
    formFieldsWrapper.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
    let fieldsHtml = '';
    window.peminjamanHeaders.forEach(header => {
        let value = data[header] || '';
        const headerLower = header.toLowerCase();
       
        if (headerLower === 'status') {
            const statusOptions = ['Disetujui', 'Diajukan', 'Ditahan', 'Selesai'];
            let radioButtonsHtml = statusOptions.map(option => `
                <label class="inline-flex items-center">
                    <input type="radio" name="Status" value="${option}" ${value === option ? 'checked' : ''} class="form-radio text-brand-green focus:ring-brand-green">
                    <span class="ml-2 text-sm text-gray-700">${option}</span>
                </label>
            `).join('');
            fieldsHtml += `
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <div class="mt-2 flex flex-wrap items-center gap-x-6 gap-y-2">${radioButtonsHtml}</div>
                </div>`;
        } else if (headerLower === 'file') {
            const fileLink = value ? `<a href="${value}" target="_blank" class="text-sm text-blue-600 hover:underline">Lihat file saat ini</a>` : '<span class="text-sm text-gray-500">Belum ada file</span>';
            fieldsHtml += `
                <div>
                    <label for="${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <input type="file" name="${header}" id="${header}" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    <div class="mt-1">${fileLink}</div>
                </div>
            `;
        } else if (headerLower === 'nomor') {
             fieldsHtml += `
                <div>
                    <label for="${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <input type="number" name="${header}" id="${header}" value="${String(value).replace(/"/g, '&quot;')}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            `;
        }
        else {
            let inputType = 'text';
            if (headerLower.includes('tanggal') || headerLower.includes('tgl')) {
                inputType = 'date';
                if (value && value.includes('/')) {
                    const parts = value.split('/');
                    if (parts.length === 3) { value = `${parts[2]}-${parts[1]}-${parts[0]}`; }
                }
            }
            fieldsHtml += `
                <div>
                    <label for="${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <input type="${inputType}" name="${header}" id="${header}" value="${String(value).replace(/"/g, '&quot;')}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            `;
        }
    });
   
    formFieldsWrapper.innerHTML = fieldsHtml;
    form.innerHTML = formHtml;
    form.appendChild(formFieldsWrapper);
    document.getElementById('peminjamanDataModal').classList.remove('hidden');
}

/**
 * --- DIPERBARUI ---
 * Fungsi ini sekarang menerima idPermohonan, bukan rowIndex.
 */
window.handleDeletePeminjamanData = function(idPermohonan) {
    showConfirmationModal(
        'Konfirmasi Hapus',
        'Apakah Anda yakin ingin menghapus data peminjaman ini?',
        'Ya, Hapus',
        () => {
            google.script.run
                .withSuccessHandler((response) => {
                    if (response.success) {
                        showNotificationModal('Berhasil', 'Data berhasil dihapus.', 'success');
                        document.dispatchEvent(new Event('reload-data'));
                    } else {
                        showNotificationModal('Gagal', response.message, 'error');
                    }
                })
                .withFailureHandler(err => showNotificationModal('Gagal', 'Gagal menghapus data: ' + err.message, 'error'))
                .deletePeminjamanData(idPermohonan);
        }
    );
}

window.handleEditLayananData = function(rowIndex, data) {
    const modal = document.getElementById('layananDataModal');
    const modalTitle = document.getElementById('layananModalTitle');
    const form = document.getElementById('layananDataForm');
   
    modalTitle.textContent = 'Edit Layanan';
    form.reset();
    let formHtml = `<input type="hidden" id="rowIndex" name="rowIndex" value="${rowIndex}">`;
    let fieldsHtml = '';
    window.layananHeaders.forEach(header => {
        const value = data[header] || '';
        const headerLower = header.toLowerCase();
        if (headerLower === 'jenis') {
            const options = ['Form', 'Kalender', 'Link'];
            let optionsHtml = options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('');
            fieldsHtml += `
                <div>
                    <label for="layanan-${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <select name="${header}" id="layanan-${header}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">${optionsHtml}</select>
                </div>`;
        } else if (headerLower === 'form' || headerLower === 'link') {
            fieldsHtml += `
                 <div class="md:col-span-2">
                    <label for="layanan-${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <textarea name="${header}" id="layanan-${header}" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">${value}</textarea>
                </div>`;
        } else {
            fieldsHtml += `
                <div>
                    <label for="layanan-${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <input type="text" name="${header}" id="layanan-${header}" value="${String(value).replace(/"/g, '&quot;')}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            `;
        }
    });
    form.innerHTML = formHtml + `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldsHtml}</div>`;
    modal.classList.remove('hidden');
}
window.handleDeleteLayananData = function(rowIndex) {
     showConfirmationModal(
        'Konfirmasi Hapus',
        'Apakah Anda yakin ingin menghapus layanan ini?',
        'Ya, Hapus',
        () => {
            google.script.run
                .withSuccessHandler(() => {
                    showNotificationModal('Berhasil', 'Layanan berhasil dihapus.', 'success');
                    google.script.run.clearCache();
                    document.dispatchEvent(new Event('reload-data'));
                })
                .withFailureHandler(err => showNotificationModal('Gagal', 'Gagal menghapus layanan: ' + err.message, 'error'))
                .deleteLayananData(rowIndex);
        }
    );
}
window.handlePrintSurat = function(printButton, data) {
    const originalIcon = printButton.innerHTML;
    printButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    printButton.disabled = true;
    google.script.run
        .withSuccessHandler((htmlContent) => {
            const newTab = window.open();
            newTab.document.write(htmlContent);
            newTab.document.close();
            printButton.innerHTML = originalIcon;
            printButton.disabled = false;
        })
        .withFailureHandler((err) => {
            showNotificationModal('Gagal', 'Gagal membuat surat: ' + err.message, 'error');
            printButton.innerHTML = originalIcon;
            printButton.disabled = false;
        })
        .getHtmlSurat(data);
}
document.addEventListener('DOMContentLoaded', function() {
  const appContainer = document.getElementById('appContainer');
  const loginContainer = document.getElementById('loginContainer');
  const loginForm = document.getElementById('loginForm');
  const errorMessage = document.getElementById('errorMessage');
  const loginButton = document.getElementById('loginButton');
  const buttonText = document.getElementById('buttonText');
  const buttonSpinner = document.getElementById('buttonSpinner');
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.getElementById('mainContent');
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const userNameDisplay = document.getElementById('userNameDisplay');
  const userRoleDisplay = document.getElementById('userRoleDisplay');
  const userProfileBtn = document.getElementById('userProfileBtn');
  const logoutButton = document.getElementById('logoutButton');
  const navLinks = document.querySelectorAll('.nav-link');
  const pages = document.querySelectorAll('.page-content');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const pageTitle = document.getElementById('pageTitle');
 
  let allPeminjamanData = [];

  const publikDataModal = document.getElementById('publikDataModal');
  const publikDataForm = document.getElementById('publikDataForm');
  const peminjamanDataModal = document.getElementById('peminjamanDataModal');
  const peminjamanDataForm = document.getElementById('peminjamanDataForm');
  const layananDataModal = document.getElementById('layananDataModal');
  const layananDataForm = document.getElementById('layananDataForm');
  const suratDataModal = document.getElementById('suratDataModal');
  const suratDataForm = document.getElementById('suratDataForm');
  const profileModal = document.getElementById('profileModal');
  const profileForm = document.getElementById('profileForm');
  window.publikHeaders = [];
  window.peminjamanHeaders = [];
  window.layananHeaders = [];
  window.akademikHeaders = [];
  window.pengaduanHeaders = [];
  window.suratHeaders = [];
 
  let autoRefreshInterval = null;
  function initializeApp() {
    const user = JSON.parse(sessionStorage.getItem('currentUser'));
    if (user) {
      showApp(user);
    } else {
      showLogin();
    }
    setupEventListeners();
    checkSidebarState();
  }
  initializeApp();
  function setupEventListeners() {
    if(loginForm) loginForm.addEventListener('submit', handleLogin);
    if(hamburgerBtn) hamburgerBtn.addEventListener('click', toggleSidebar);
    if(logoutButton) logoutButton.addEventListener('click', handleLogout);
    if(userProfileBtn) userProfileBtn.addEventListener('click', openProfileModal);
    if(profileForm) profileForm.addEventListener('submit', handleProfileSave);
    navLinks.forEach(link => link.addEventListener('click', handleNavigation));
   
    document.addEventListener('reload-data', () => {
        const user = JSON.parse(sessionStorage.getItem('currentUser'));
        if(user) loadInitialData(user);
    });
   
    if(sidebarOverlay) sidebarOverlay.addEventListener('click', () => {
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
    });
    document.getElementById('addPublikDataBtn')?.addEventListener('click', handleAddPublikData);
    document.getElementById('closePublikModalBtn')?.addEventListener('click', () => publikDataModal.classList.add('hidden'));
    document.getElementById('cancelPublikModalBtn')?.addEventListener('click', () => publikDataModal.classList.add('hidden'));
    if(publikDataForm) publikDataForm.addEventListener('submit', handleSavePublikData);
    document.getElementById('addPeminjamanDataBtn')?.addEventListener('click', handleAddPeminjamanData);
    document.getElementById('closePeminjamanModalBtn')?.addEventListener('click', () => peminjamanDataModal.classList.add('hidden'));
    document.getElementById('cancelPeminjamanModalBtn')?.addEventListener('click', () => peminjamanDataModal.classList.add('hidden'));
    if(peminjamanDataForm) peminjamanDataForm.addEventListener('submit', handleSavePeminjamanData);
   
    document.getElementById('addLayananDataBtn')?.addEventListener('click', handleAddLayananData);
    document.getElementById('closeLayananModalBtn')?.addEventListener('click', () => layananDataModal.classList.add('hidden'));
    document.getElementById('cancelLayananModalBtn')?.addEventListener('click', () => layananDataModal.classList.add('hidden'));
    if(layananDataForm) layananDataForm.addEventListener('submit', handleSaveLayananData);
    
    document.getElementById('addSuratDataBtn')?.addEventListener('click', handleAddSuratData);
    document.getElementById('closeSuratModalBtn')?.addEventListener('click', () => suratDataModal.classList.add('hidden'));
    document.getElementById('cancelSuratModalBtn')?.addEventListener('click', () => suratDataModal.classList.add('hidden'));
    if(suratDataForm) suratDataForm.addEventListener('submit', handleSaveSuratData);

    document.getElementById('closeProfileModalBtn')?.addEventListener('click', () => profileModal.classList.add('hidden'));
    document.getElementById('cancelProfileModalBtn')?.addEventListener('click', () => profileModal.classList.add('hidden'));

    document.getElementById('peminjamanSearchInput')?.addEventListener('input', applyPeminjamanFilters);
    document.getElementById('peminjamanMonthFilter')?.addEventListener('change', applyPeminjamanFilters);
    document.getElementById('peminjamanJenisFilter')?.addEventListener('change', applyPeminjamanFilters);
    document.getElementById('peminjamanResetBtn')?.addEventListener('click', resetPeminjamanFilters);
    document.getElementById('peminjamanReloadBtn')?.addEventListener('click', () => {
        const btn = document.getElementById('peminjamanReloadBtn');
        const icon = btn.querySelector('i');
        icon.classList.add('fa-spin');
        document.dispatchEvent(new Event('reload-data'));
    });
  }
  function handleLogin(e) {
    e.preventDefault();
    setLoadingState(true);
    const username = e.target.username.value;
    const password = e.target.password.value;
    google.script.run
      .withSuccessHandler(onLoginSuccess)
      .withFailureHandler(onLoginFailure)
      .authenticateUser(username, password);
  }
 
  function onLoginSuccess(user) {
    if (user) {
      sessionStorage.setItem('currentUser', JSON.stringify(user));
      showApp(user);
    } else {
      errorMessage.textContent = 'NIP/Username atau Password salah.';
      errorMessage.classList.remove('hidden');
      setLoadingState(false);
    }
  }
    function onLoginFailure(error) {
    errorMessage.textContent = 'Terjadi kesalahan. Coba lagi.';
    errorMessage.classList.remove('hidden');
    setLoadingState(false);
    console.error('Login failed:', error);
  }
 
  /**
   * --- DIPERBARUI ---
   * Membersihkan session dan menampilkan halaman login secara manual.
   */
  function handleLogout(e) {
    e.preventDefault();
    sessionStorage.removeItem('currentUser');
    window.location.hash = '';
    
    // PERBAIKAN: Panggil showLogin() dan reset kondisi tombol login
    if (loginForm) loginForm.reset();
    if (errorMessage) errorMessage.classList.add('hidden');
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    
    setLoadingState(false); // Tambahkan baris ini untuk mereset tombol
    showLogin();
  }

  function showApp(user) {
    loginContainer.classList.add('hidden');
    loginContainer.classList.remove('flex');
    appContainer.classList.remove('hidden');
    userNameDisplay.textContent = user.name;
    userRoleDisplay.textContent = user.peran || 'Biasa';
    updateSidebarVisibility(user);
    loadInitialData(user);
    navigateTo(window.location.hash || '#peminjaman');
  }
  function showLogin() {
    appContainer.classList.add('hidden');
    loginContainer.classList.remove('hidden');
    loginContainer.classList.add('flex');
  }
  function setLoadingState(isLoading) {
    if (isLoading) {
      buttonText.classList.add('hidden');
      buttonSpinner.classList.remove('hidden');
      loginButton.disabled = true;
    } else {
      buttonText.classList.remove('hidden');
      buttonSpinner.classList.add('hidden');
      loginButton.disabled = false;
    }
  }
  function loadInitialData(user) {
    google.script.run
      .withSuccessHandler(onDataSuccess)
      .withFailureHandler(onDataFailure)
      .getInitialData(user);
  }
  
  function onDataSuccess(data) {
    if (data.error) {
      console.error(data.error);
      showNotificationModal('Error', data.error, 'error');
      return;
    }

    const reloadBtn = document.getElementById('peminjamanReloadBtn');
    if (reloadBtn) {
        reloadBtn.querySelector('i').classList.remove('fa-spin');
    }

    if (typeof renderLayananPage === 'function' && data.layanan) {
        renderLayananPage(data.layanan.headers, data.layanan.data);
    }
    if (typeof renderPublikPage === 'function' && data.publik) {
        renderPublikPage(data.publik.headers, data.publik.data);
    }
    if (typeof renderPengaduanPage === 'function' && data.pengaduan) {
        renderPengaduanPage(data.pengaduan.headers, data.pengaduan.data);
    }
    if (typeof renderAkademikPage === 'function' && data.akademik) {
        renderAkademikPage(data.akademik.headers, data.akademik.data);
    }
    if (typeof renderSuratPage === 'function' && data.surat) {
        renderSuratPage(data.surat.headers, data.surat.data);
    }
    
    if (typeof renderPeminjamanPage === 'function' && data.peminjaman) {
        allPeminjamanData = [...data.peminjaman.data];
        window.peminjamanHeaders = data.peminjaman.headers;
        populatePeminjamanFilters();
        applyPeminjamanFilters();
    }
  }
 
  function onDataFailure(error) {
    console.error('Gagal memuat data awal:', error);
    showNotificationModal('Error', 'Gagal memuat data dari server.', 'error');
  }
 
  function updateSidebarVisibility(user) {
    const accessibleMenus = user.menus;
    if (accessibleMenus === '*') {
        document.querySelectorAll('#sidebar [data-menu-id]').forEach(menu => {
            menu.style.display = '';
        });
        return;
    }
    const allowedMenus = accessibleMenus.split(',').map(m => m.trim());
    document.querySelectorAll('#sidebar [data-menu-id]').forEach(menu => {
        const menuId = menu.dataset.menuId;
        if (allowedMenus.includes(menuId)) {
            menu.style.display = '';
        } else {
            menu.style.display = 'none';
        }
    });
  }
  function toggleSidebar() {
    if (window.innerWidth < 768) {
        sidebar.classList.toggle('-translate-x-full');
        sidebarOverlay.classList.toggle('hidden');
    } else {
        sidebar.classList.toggle('sidebar-collapsed');
        localStorage.setItem('sidebarState', sidebar.classList.contains('sidebar-collapsed') ? 'collapsed' : 'expanded');
    }
  }
  function checkSidebarState() {
    if (window.innerWidth >= 768 && localStorage.getItem('sidebarState') === 'collapsed') {
      sidebar.classList.add('sidebar-collapsed');
    }
  }
  function handleNavigation(e) {
    e.preventDefault();
    const targetId = e.currentTarget.getAttribute('href');
    navigateTo(targetId);
    if (window.innerWidth < 768) {
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
    }
  }
  function navigateTo(hash) {
    const pageTitles = {
      '#peminjaman': 'Data Peminjaman',
      '#pengaduan': 'Data Pengaduan',
      '#akademik': 'Keterangan Akademik',
      '#layanan': 'Daftar Layanan',
      '#publik': 'Data Publik',
      '#surat': 'Konfigurasi Surat'
    };
    pageTitle.textContent = pageTitles[hash] || 'Data Peminjaman';
   
    pages.forEach(page => page.classList.add('hidden'));
    navLinks.forEach(link => {
      link.classList.remove('bg-gray-100', 'font-semibold');
      link.classList.add('text-gray-500');
    });
    const fabButtons = ['#addPeminjamanDataBtn', '#addPublikDataBtn', '#addLayananDataBtn', '#addAkademikDataBtn', '#addSuratDataBtn'];
    fabButtons.forEach(btnId => {
        const btn = document.querySelector(btnId);
        if(btn) btn.classList.add('hidden');
    });
   
    const targetPage = document.querySelector(hash.replace('#', '#page-'));
    const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
    if (targetPage) {
      targetPage.classList.remove('hidden');
      const fabId = `#add${hash.charAt(1).toUpperCase() + hash.slice(2)}DataBtn`;
      const fab = document.querySelector(fabId);
      if(fab) fab.classList.remove('hidden');
    } else {
      document.getElementById('page-peminjaman').classList.remove('hidden');
    }
    if (activeLink) {
      activeLink.classList.add('bg-gray-100', 'font-semibold');
      activeLink.classList.remove('text-gray-500');
    }
    window.location.hash = hash;
  }
 
  // --- FUNGSI RENDER HALAMAN ---
  function handleAddLayananData() {
    const layananModalTitle = document.getElementById('layananModalTitle');
    const layananDataForm = document.getElementById('layananDataForm');
    layananModalTitle.textContent = 'Tambah Layanan Baru';
    layananDataForm.reset();
    let formHtml = '<input type="hidden" id="rowIndex" name="rowIndex">';
    let fieldsHtml = '';
    window.layananHeaders.forEach(header => {
        const headerLower = header.toLowerCase();
        if (headerLower === 'jenis') {
            const options = ['Form', 'Kalender', 'Link'];
            let optionsHtml = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            fieldsHtml += `
                <div>
                    <label for="layanan-${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <select name="${header}" id="layanan-${header}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">${optionsHtml}</select>
                </div>`;
        } else if (headerLower === 'form' || headerLower === 'link') {
            fieldsHtml += `
                 <div class="md:col-span-2">
                    <label for="layanan-${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <textarea name="${header}" id="layanan-${header}" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"></textarea>
                </div>`;
        } else {
            fieldsHtml += `
                <div>
                    <label for="layanan-${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <input type="text" name="${header}" id="layanan-${header}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            `;
        }
    });
    layananDataForm.innerHTML = formHtml + `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldsHtml}</div>`;
    document.getElementById('layananDataModal').classList.remove('hidden');
  }
  function handleSaveLayananData(e) {
    e.preventDefault();
    const saveBtn = document.getElementById('saveLayananDataBtn');
    const btnSpan = saveBtn.querySelector('span');
    const originalText = btnSpan.textContent;
    btnSpan.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    saveBtn.disabled = true;
    const formData = new FormData(e.target);
    const dataObject = Object.fromEntries(formData.entries());
    const rowIndex = dataObject.rowIndex;
   
    const serverFunction = rowIndex ? 'updateLayananData' : 'addLayananData';
    const params = rowIndex ? [rowIndex, dataObject] : [dataObject];
   
    google.script.run
        .withSuccessHandler(response => {
            if (response.success) {
                closeLayananModal();
                showNotificationModal('Berhasil', 'Data layanan berhasil disimpan.', 'success');
                google.script.run.clearCache();
                const user = JSON.parse(sessionStorage.getItem('currentUser'));
                if(user) loadInitialData(user);
            } else {
                showNotificationModal('Gagal', 'Gagal menyimpan data: ' + response.message, 'error');
            }
            btnSpan.textContent = originalText;
            saveBtn.disabled = false;
        })
        .withFailureHandler(err => {
            showNotificationModal('Error', 'Terjadi kesalahan: ' + err.message, 'error');
            btnSpan.textContent = originalText;
            saveBtn.disabled = false;
        })
        [serverFunction](...params);
  }
 
  function closeLayananModal() {
    document.getElementById('layananDataModal').classList.add('hidden');
  }
  function renderLayananPage(headers, data) {
    window.layananHeaders = headers;
    const cardsContainer = document.getElementById('layanan-cards-grid');
    cardsContainer.innerHTML = '';
   
    if (!data || data.length === 0) {
      cardsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-10">Tidak ada data layanan. Klik '+' untuk menambah.</p>`;
      return;
    }
   
    let allCardsHtml = '';
    data.forEach((item, index) => {
      const jenis = item['Jenis'] || 'Form';
      const jenisLabelClass = {
        'Form': 'bg-blue-100 text-blue-800',
        'Kalender': 'bg-purple-100 text-purple-800',
        'Link': 'bg-yellow-100 text-yellow-800'
      }[jenis] || 'bg-gray-100 text-gray-800';
      allCardsHtml += `
        <div class="bg-white rounded-lg shadow p-4 flex flex-col cursor-pointer hover:shadow-md transition-shadow relative" onclick="window.handleEditLayananData(${index}, ${JSON.stringify(item).replace(/"/g, '&quot;')})">
            <button onclick="event.stopPropagation(); window.handleDeleteLayananData(${index})" class="absolute top-2 right-2 w-7 h-7 flex items-center justify-center bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors">
                <i class="fas fa-times text-sm"></i>
            </button>
            <h3 class="font-bold text-lg text-brand-green mb-2 pr-8">${item['Jenis Layanan'] || 'N/A'}</h3>
            <div class="text-sm space-y-1 text-gray-600 flex-grow">
                <p><span class="font-semibold text-gray-800">Kategori:</span> ${item['Kategori'] || '-'}</p>
                <p><span class="font-semibold text-gray-800">Pengolah:</span> ${item['Pengolah'] || '-'}</p>
            </div>
            <div class="mt-3 pt-3 border-t">
                <span class="text-xs font-semibold rounded-full px-2 py-0.5 ${jenisLabelClass}">${jenis}</span>
            </div>
        </div>`;
    });
    cardsContainer.innerHTML = allCardsHtml;
  }
  function handleAddPublikData() {
    document.getElementById('publikModalTitle').textContent = 'Tambah Data Publik';
    const publikDataForm = document.getElementById('publikDataForm');
    publikDataForm.reset();
   
    let formHtml = '<input type="hidden" id="rowIndex" name="rowIndex">';
    let fieldsHtml = '';
    window.publikHeaders.forEach(header => {
        const safeHeaderId = header.replace(/\s+/g, '-');
        if (header.toLowerCase() === 'jenis') {
            const options = ['Info', 'Pin', 'Link', 'Footer Link'];
            let optionsHtml = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            fieldsHtml += `
                <div>
                    <label for="${safeHeaderId}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <select name="${header}" id="${safeHeaderId}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">${optionsHtml}</select>
                </div>
            `;
        } else if (header.toLowerCase() === 'warna') {
            const softColors = ['#e0f2fe', '#fef9c3', '#dcfce7', '#f3e8ff', '#ffe4e6'];
            const vibrantColors = ['#3b82f6', '#f59e0b', '#22c55e', '#a855f7', '#ef4444'];
           
            const createColorOptions = (colors) => {
                return colors.map(color => `
                    <label class="cursor-pointer">
                        <input type="radio" name="Warna" value="${color}" class="sr-only">
                        <span class="block w-8 h-8 rounded-full border-2 border-transparent ring-2 ring-offset-1" style="background-color: ${color};"></span>
                    </label>
                `).join('');
            };
            fieldsHtml += `
                <div class="md:col-span-2">
                    <label for="${safeHeaderId}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <div class="mt-2 space-y-3" id="color-palette">
                        <div class="flex items-center gap-3">${createColorOptions(softColors)}</div>
                        <div class="flex items-center gap-3 mt-3">${createColorOptions(vibrantColors)}</div>
                    </div>
                </div>`;
        } else {
            fieldsHtml += `
                <div>
                    <label for="${safeHeaderId}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <input type="text" name="${header}" id="${safeHeaderId}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            `;
        }
    });
    publikDataForm.innerHTML = formHtml + `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldsHtml}</div>`;
   
    const palette = publikDataForm.querySelector('#color-palette');
    if (palette) {
        palette.addEventListener('change', (e) => {
            if (e.target.type === 'radio') {
                palette.querySelectorAll('span').forEach(span => span.classList.remove('ring-blue-500'));
                e.target.nextElementSibling.classList.add('ring-blue-500');
            }
        });
    }
    document.getElementById('publikDataModal').classList.remove('hidden');
  }
  function handleSavePublikData(e) {
    e.preventDefault();
    const saveBtn = document.getElementById('savePublikDataBtn');
    const btnSpan = saveBtn.querySelector('span');
    const originalText = btnSpan.textContent;
    btnSpan.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    saveBtn.disabled = true;
    const formData = new FormData(e.target);
    const dataObject = Object.fromEntries(formData.entries());
    const rowIndex = dataObject.rowIndex;
    const serverFunction = rowIndex ? 'updateInfoData' : 'addInfoData';
    const params = rowIndex ? [rowIndex, dataObject] : [dataObject];
    google.script.run
        .withSuccessHandler(response => {
            if (response.success) {
                showNotificationModal('Berhasil', 'Data berhasil disimpan.', 'success');
                google.script.run.clearCache();
                closePublikModal();
                const user = JSON.parse(sessionStorage.getItem('currentUser'));
                if(user) loadInitialData(user);
            } else {
                showNotificationModal('Gagal', 'Gagal menyimpan data: ' + response.message, 'error');
            }
            btnSpan.textContent = originalText;
            saveBtn.disabled = false;
        })
        .withFailureHandler(err => {
            showNotificationModal('Error', 'Terjadi kesalahan: ' + err.message, 'error');
            btnSpan.textContent = originalText;
            saveBtn.disabled = false;
        })
        [serverFunction](...params);
  }
  function closePublikModal() {
    document.getElementById('publikDataModal').classList.add('hidden');
  }
  function getJenisLabelClass(jenis) {
    const lowerJenis = (jenis || '').toLowerCase();
    switch (lowerJenis) {
        case 'info': return 'bg-blue-100 text-blue-800';
        case 'pin': return 'bg-green-100 text-green-800';
        case 'link': return 'bg-yellow-100 text-yellow-800';
        case 'footer link': return 'bg-purple-100 text-purple-800';
        default: return 'bg-gray-100 text-gray-800';
    }
  }
  function renderPublikPage(headers, data) {
    const headersContainer = document.getElementById('publik-headers');
    const bodyContainer = document.getElementById('publik-body');
    const cardsContainer = document.getElementById('publik-cards');
   
    headersContainer.innerHTML = '';
    bodyContainer.innerHTML = '';
    cardsContainer.innerHTML = '';
   
    window.publikHeaders = headers;
   
    const columnsToHide = ['Gambar', 'Warna', 'Tanggal Post'];
    const displayHeaders = headers.filter(h => !columnsToHide.includes(h));
    let tableHeadersHtml = displayHeaders.map(header => {
      let widthClass = '';
      if(header.toLowerCase() === 'info') widthClass = 'w-1/3';
      return `<th scope="col" class="${widthClass} px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`
    }).join('');
    tableHeadersHtml += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>`;
    headersContainer.innerHTML = tableHeadersHtml;
   
    if (!data || data.length === 0) {
      bodyContainer.innerHTML = `<tr><td colspan="${displayHeaders.length + 1}" class="p-4 text-center text-gray-500">Tidak ada data publik.</td></tr>`;
      cardsContainer.innerHTML = `<div class="p-4 text-center text-gray-500">Tidak ada data publik.</div>`;
      return;
    }
   
    let allRowsHtml = '';
    let allCardsHtml = '';
    data.forEach((item, index) => {
        let rowHtml = '<tr>';
        displayHeaders.forEach(header => {
            let cellContent = item[header] || '';
            if (header.toLowerCase() === 'jenis') {
                cellContent = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getJenisLabelClass(item['Jenis'])}">${cellContent}</span>`;
            } else if (header.toLowerCase() === 'link' && cellContent) {
                cellContent = `<a href="${cellContent}" target="_blank" rel="noopener noreferrer" class="bg-blue-500 text-white text-xs font-semibold px-3 py-1 rounded-full hover:bg-blue-600">Lihat</a>`;
            }
            rowHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${cellContent}</td>`;
        });
       
        rowHtml += `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                <button onclick="window.handleEditPublikData(${index}, ${JSON.stringify(item).replace(/"/g, '&quot;')})" class="w-8 h-8 inline-flex items-center justify-center bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200"><i class="fas fa-pencil-alt"></i></button>
                <button onclick="window.handleDeletePublikData(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-red-100 text-red-600 rounded-md hover:bg-red-200"><i class="fas fa-trash-alt"></i></button>
            </td>
        `;
        rowHtml += '</tr>';
        allRowsHtml += rowHtml;
        let cardHtml = `
          <div class="bg-white rounded-lg shadow p-4 space-y-3">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <p class="text-xs text-gray-500 uppercase">Info</p>
                <p class="font-bold text-gray-800">${item['Info'] || ''}</p>
              </div>
              <span class="text-xs font-semibold rounded-full px-2 py-0.5 ${getJenisLabelClass(item['Jenis'])}">${item['Jenis'] || ''}</span>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase">Link</p>
              ${item['Link'] ? `<a href="${item['Link']}" target="_blank" rel="noopener noreferrer" class="inline-block mt-1 bg-blue-500 text-white text-xs font-semibold px-3 py-1 rounded-full hover:bg-blue-600">Lihat</a>` : '<p class="text-sm text-gray-400">-</p>'}
            </div>
            <div class="border-t pt-3 flex justify-end space-x-2">
                <button onclick="window.handleEditPublikData(${index}, ${JSON.stringify(item).replace(/"/g, '&quot;')})" class="w-8 h-8 inline-flex items-center justify-center bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200"><i class="fas fa-pencil-alt"></i></button>
                <button onclick="window.handleDeletePublikData(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-red-100 text-red-600 rounded-md hover:bg-red-200"><i class="fas fa-trash-alt"></i></button>
            </div>
          </div>
        `;
        allCardsHtml += cardHtml;
    });
    bodyContainer.innerHTML = allRowsHtml;
    cardsContainer.innerHTML = allCardsHtml;
  }
 
  function handleAddPeminjamanData() {
    const peminjamanModalTitle = document.getElementById('peminjamanModalTitle');
    const peminjamanDataForm = document.getElementById('peminjamanDataForm');
    peminjamanModalTitle.textContent = 'Tambah Data Peminjaman';
    peminjamanDataForm.reset();
   
    let formHtml = '<input type="hidden" id="idPermohonan" name="idPermohonan" value="">';
    const formFieldsWrapper = document.createElement('div');
    formFieldsWrapper.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
    let fieldsHtml = '';
    window.peminjamanHeaders.forEach(header => {
       if (header.toLowerCase() === 'status') {
            const statusOptions = ['Disetujui', 'Diajukan', 'Ditahan', 'Selesai'];
            let radioButtonsHtml = statusOptions.map(option => `
                <label class="inline-flex items-center">
                    <input type="radio" name="Status" value="${option}" ${option === 'Diajukan' ? 'checked' : ''} class="form-radio text-brand-green focus:ring-brand-green">
                    <span class="ml-2 text-sm text-gray-700">${option}</span>
                </label>
            `).join('');
            fieldsHtml += `
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <div class="mt-2 flex flex-wrap items-center gap-x-6 gap-y-2">${radioButtonsHtml}</div>
                </div>`;
        } else {
            const inputType = header.toLowerCase().includes('tanggal') || header.toLowerCase().includes('tgl') ? 'date' : 'text';
            fieldsHtml += `
                <div>
                    <label for="${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                    <input type="${inputType}" name="${header}" id="${header}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
            `;
        }
    });
   
    formFieldsWrapper.innerHTML = fieldsHtml;
    peminjamanDataForm.innerHTML = formHtml;
    peminjamanDataForm.appendChild(formFieldsWrapper);
    document.getElementById('peminjamanDataModal').classList.remove('hidden');
  }

  /**
   * --- DIPERBARUI ---
   * Menggunakan idPermohonan sebagai kunci untuk update/add.
   */
  function handleSavePeminjamanData(e) {
    e.preventDefault();
    const saveBtn = document.getElementById('savePeminjamanDataBtn');
    const btnSpan = saveBtn.querySelector('span');
    const originalText = btnSpan.textContent;
    btnSpan.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    saveBtn.disabled = true;
    const formData = new FormData(e.target);
    const dataObject = Object.fromEntries(formData.entries());
   
    const fileInput = e.target.querySelector('input[type="file"][name="File"]');
    const file = fileInput ? fileInput.files[0] : null;

    const runServerCall = (fileData = null) => {
        if (fileData) {
            dataObject.fileData = fileData;
        }
       
        delete dataObject.File;
        const idPermohonan = dataObject.idPermohonan;

        const isUpdate = idPermohonan && idPermohonan !== ''; 
        const serverFunction = isUpdate ? 'updatePeminjamanData' : 'addPeminjamanData';
        const params = isUpdate ? [idPermohonan, dataObject] : [dataObject];

        google.script.run
            .withSuccessHandler(response => {
                if (response.success) {
                    closePeminjamanModal();
                    showNotificationModal('Berhasil', 'Data berhasil disimpan.', 'success');
                    document.dispatchEvent(new Event('reload-data'));
                } else {
                    showNotificationModal('Gagal', response.message || 'Gagal menyimpan data.', 'error');
                }
                btnSpan.textContent = originalText;
                saveBtn.disabled = false;
            })
            .withFailureHandler(err => {
                showNotificationModal('Error', 'Terjadi kesalahan: ' + err.message, 'error');
                btnSpan.textContent = originalText;
                saveBtn.disabled = false;
            })
            [serverFunction](...params);
    };

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Data = e.target.result.split(',')[1];
            const fileData = {
                base64Data: base64Data,
                name: file.name,
                type: file.type
            };
            runServerCall(fileData);
        };
        reader.onerror = function() {
             showNotificationModal('Error', 'Gagal membaca file.', 'error');
             btnSpan.textContent = originalText;
             saveBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    } else {
        runServerCall();
    }
  }

  function closePeminjamanModal() {
    document.getElementById('peminjamanDataModal').classList.add('hidden');
  }
  function getStatusLabelClass(status) {
    const lowerStatus = (status || '').toLowerCase();
    switch (lowerStatus) {
        case 'disetujui': return 'bg-green-100 text-green-800';
        case 'diajukan': return 'bg-yellow-100 text-yellow-800';
        case 'ditahan': return 'bg-orange-100 text-orange-800';
        case 'selesai': return 'bg-blue-100 text-blue-800';
        default: return 'bg-gray-100 text-gray-800';
    }
  }

  function populatePeminjamanFilters() {
      const monthFilter = document.getElementById('peminjamanMonthFilter');
      const jenisFilter = document.getElementById('peminjamanJenisFilter');
      if (!monthFilter || !jenisFilter) return;

      const months = new Set();
      const jenis = new Set();
      const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

      allPeminjamanData.forEach(item => {
          if (item['Tanggal'] && item['Tanggal'].includes('/')) {
              const parts = item['Tanggal'].split('/');
              if (parts.length === 3) {
                  const monthIndex = parseInt(parts[1], 10) - 1;
                  if (!isNaN(monthIndex) && monthIndex >= 0 && monthIndex < 12) {
                      months.add(JSON.stringify({key: `${parts[2]}-${parts[1].padStart(2, '0')}`, name: `${monthNames[monthIndex]} ${parts[2]}`}));
                  }
              }
          }
          if (item['Jenis Layanan']) {
              jenis.add(item['Jenis Layanan']);
          }
      });

      monthFilter.innerHTML = '<option value="">Semua Bulan</option>';
      const sortedMonths = Array.from(months).map(JSON.parse).sort((a, b) => b.key.localeCompare(a.key));
      sortedMonths.forEach(monthObj => {
          const option = document.createElement('option');
          option.value = monthObj.key.split('-')[1]; 
          option.textContent = monthObj.name;
          monthFilter.appendChild(option);
      });

      jenisFilter.innerHTML = '<option value="">Semua Jenis</option>';
      jenis.forEach(j => {
          const option = document.createElement('option');
          option.value = j;
          option.textContent = j;
          jenisFilter.appendChild(option);
      });
  }

  function applyPeminjamanFilters() {
      const monthValue = document.getElementById('peminjamanMonthFilter').value;
      const jenisValue = document.getElementById('peminjamanJenisFilter').value;
      const searchValue = document.getElementById('peminjamanSearchInput').value.toLowerCase();

      let filteredData = [...allPeminjamanData];

      if (monthValue) {
          filteredData = filteredData.filter(item => {
              if (!item['Tanggal'] || !item['Tanggal'].includes('/')) return false;
              const parts = item['Tanggal'].split('/');
              return parts.length === 3 && parseInt(parts[1], 10) == parseInt(monthValue, 10);
          });
      }

      if (jenisValue) {
          filteredData = filteredData.filter(item => item['Jenis Layanan'] === jenisValue);
      }

      if (searchValue) {
          filteredData = filteredData.filter(item => 
              ['Nama', 'Kegiatan', 'IDPermohonan'].some(key => 
                  item[key] && String(item[key]).toLowerCase().includes(searchValue)
              )
          );
      }
      renderPeminjamanPage(window.peminjamanHeaders, filteredData);
  }

  function resetPeminjamanFilters() {
      document.getElementById('peminjamanMonthFilter').value = '';
      document.getElementById('peminjamanJenisFilter').value = '';
      document.getElementById('peminjamanSearchInput').value = '';
      renderPeminjamanPage(window.peminjamanHeaders, allPeminjamanData);
  }
  
  /**
   * --- DIPERBARUI ---
   * Tombol Edit/Hapus sekarang menggunakan IDPermohonan sebagai kunci.
   */
  function renderPeminjamanPage(headers, data) {
    const headersContainer = document.getElementById('peminjaman-headers');
    const bodyContainer = document.getElementById('peminjaman-body');
    const cardsContainer = document.getElementById('peminjaman-cards');
   
    headersContainer.innerHTML = '';
    bodyContainer.innerHTML = '';
    cardsContainer.innerHTML = '';
   
    if (!headers || headers.length === 0) return;
    const columnsToShow = {
        'IDPermohonan': 'ID',
        'Tanggal': 'Tanggal',
        'Jenis Layanan': 'Jenis',
        'Nama': 'Nama',
        'Tanggal Mulai': 'Tgl Mulai',
        'Tanggal Selesai': 'Tgl Selesai',
        'Status': 'Status'
    };
    const displayHeaders = Object.values(columnsToShow);
    const originalHeaders = Object.keys(columnsToShow);
    let tableHeadersHtml = displayHeaders.map(header => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`).join('');
    tableHeadersHtml += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>`;
    headersContainer.innerHTML = tableHeadersHtml;
   
    if (!data || data.length === 0) {
      bodyContainer.innerHTML = `<tr><td colspan="${displayHeaders.length + 1}" class="p-4 text-center text-gray-500">Tidak ada data yang cocok dengan filter.</td></tr>`;
      cardsContainer.innerHTML = `<div class="p-4 text-center text-gray-500">Tidak ada data yang cocok dengan filter.</div>`;
      return;
    }
   
    let allRowsHtml = '';
    let allCardsHtml = '';
    data.forEach((item) => {
        const idPermohonan = item['IDPermohonan'];

        let rowHtml = '<tr>';
        originalHeaders.forEach(header => {
            let cellContent = item[header] || '';
            let cellClass = 'px-6 py-4 text-sm text-gray-700';
            if (header.toLowerCase() === 'status') {
                cellContent = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusLabelClass(item['Status'])}">${cellContent}</span>`;
                cellClass += ' whitespace-nowrap';
            }
            rowHtml += `<td class="${cellClass}">${cellContent}</td>`;
        });
       
        const status = (item['Status'] || '').toLowerCase();
        const canPrint = status === 'disetujui' || status === 'selesai';
        const printButtonClass = canPrint ? 'bg-green-100 text-green-600 hover:bg-green-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed';
        const printButtonDisabled = canPrint ? '' : 'disabled';
        const printButtonHtml = `
            <button onclick='window.handlePrintSurat(this, ${JSON.stringify(item).replace(/'/g, "&apos;")})'
                    class="w-8 h-8 flex-shrink-0 inline-flex items-center justify-center rounded-md ${printButtonClass}"
                    title="Cetak Surat" ${printButtonDisabled}>
                <i class="fas fa-print"></i>
            </button>`;
           
        rowHtml += `
            <td class="px-6 py-4 text-sm font-medium whitespace-nowrap">
              <div class="flex items-center space-x-2">
                ${printButtonHtml}
                <button onclick='window.handleEditPeminjamanData("${idPermohonan}", ${JSON.stringify(item).replace(/'/g, "&apos;")})' class="w-8 h-8 flex-shrink-0 inline-flex items-center justify-center bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200" title="Edit Data"><i class="fas fa-pencil-alt"></i></button>
                <button onclick='window.handleDeletePeminjamanData("${idPermohonan}")' class="w-8 h-8 flex-shrink-0 inline-flex items-center justify-center bg-red-100 text-red-600 rounded-md hover:bg-red-200" title="Hapus Data"><i class="fas fa-trash-alt"></i></button>
              </div>
            </td>
        `;
        rowHtml += '</tr>';
        allRowsHtml += rowHtml;

        let cardHtml = '<div class="bg-white rounded-lg shadow p-4 space-y-3">';
        originalHeaders.forEach(header => {
            let cellContent = item[header] || '';
            if (header.toLowerCase() === 'status') {
                cellContent = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusLabelClass(item['Status'])}">${cellContent}</span>`;
            }
            cardHtml += `
                <div>
                    <p class="text-xs text-gray-500 uppercase">${columnsToShow[header]}</p>
                    <div class="text-sm font-medium text-gray-800">${cellContent}</div>
                </div>`;
        });
       
        cardHtml += `
            <div class="border-t pt-3 flex justify-end space-x-2">
                 ${printButtonHtml}
                <button onclick='window.handleEditPeminjamanData("${idPermohonan}", ${JSON.stringify(item).replace(/'/g, "&apos;")})' class="w-8 h-8 inline-flex items-center justify-center bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200" title="Edit Data"><i class="fas fa-pencil-alt"></i></button>
                <button onclick='window.handleDeletePeminjamanData("${idPermohonan}")' class="w-8 h-8 inline-flex items-center justify-center bg-red-100 text-red-600 rounded-md hover:bg-red-200" title="Hapus Data"><i class="fas fa-trash-alt"></i></button>
            </div>
        `;
        cardHtml += '</div>';
        allCardsHtml += cardHtml;
    });
    bodyContainer.innerHTML = allRowsHtml;
    cardsContainer.innerHTML = allCardsHtml;
  }
  
  // --- BARU: FUNGSI-FUNGSI UNTUK HALAMAN SURAT ---

  window.handleEditSuratData = function(rowIndex, data) {
    document.getElementById('suratModalTitle').textContent = 'Edit Konfigurasi Surat';
    const form = document.getElementById('suratDataForm');
    form.reset();
   
    let formHtml = `<input type="hidden" id="rowIndex" name="rowIndex" value="${rowIndex}">`;
    let fieldsHtml = '';
    window.suratHeaders.forEach(header => {
        const value = data[header] || '';
        fieldsHtml += `
            <div>
                <label for="surat-${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                <input type="text" name="${header}" id="surat-${header}" value="${String(value).replace(/"/g, '&quot;')}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            </div>
        `;
    });
   
    form.innerHTML = formHtml + `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldsHtml}</div>`;
    document.getElementById('suratDataModal').classList.remove('hidden');
  }

  window.handleDeleteSuratData = function(rowIndex) {
    showConfirmationModal(
        'Konfirmasi Hapus',
        'Apakah Anda yakin ingin menghapus konfigurasi surat ini?',
        'Ya, Hapus',
        () => {
            google.script.run
                .withSuccessHandler(() => {
                    showNotificationModal('Berhasil', 'Data berhasil dihapus.', 'success');
                    document.dispatchEvent(new Event('reload-data'));
                })
                .withFailureHandler(err => showNotificationModal('Gagal', 'Gagal menghapus data: ' + err.message, 'error'))
                .deleteSuratData(rowIndex);
        }
    );
  }

  function handleAddSuratData() {
    document.getElementById('suratModalTitle').textContent = 'Tambah Konfigurasi Surat';
    const form = document.getElementById('suratDataForm');
    form.reset();
   
    let formHtml = '<input type="hidden" id="rowIndex" name="rowIndex" value="">';
    let fieldsHtml = '';
    window.suratHeaders.forEach(header => {
        fieldsHtml += `
            <div>
                <label for="surat-${header}" class="block text-sm font-medium text-gray-700">${header}</label>
                <input type="text" name="${header}" id="surat-${header}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            </div>
        `;
    });
   
    form.innerHTML = formHtml + `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldsHtml}</div>`;
    document.getElementById('suratDataModal').classList.remove('hidden');
  }

  function handleSaveSuratData(e) {
    e.preventDefault();
    const saveBtn = document.getElementById('saveSuratDataBtn');
    const btnSpan = saveBtn.querySelector('span');
    const originalText = btnSpan.textContent;
    btnSpan.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    saveBtn.disabled = true;

    const formData = new FormData(e.target);
    const dataObject = Object.fromEntries(formData.entries());
    const rowIndex = dataObject.rowIndex;

    const isUpdate = rowIndex !== '';
    const serverFunction = isUpdate ? 'updateSuratData' : 'addSuratData';
    const params = isUpdate ? [rowIndex, dataObject] : [dataObject];

    google.script.run
        .withSuccessHandler(response => {
            if (response.success) {
                document.getElementById('suratDataModal').classList.add('hidden');
                showNotificationModal('Berhasil', 'Data surat berhasil disimpan.', 'success');
                document.dispatchEvent(new Event('reload-data'));
            } else {
                showNotificationModal('Gagal', 'Gagal menyimpan data: ' + response.message, 'error');
            }
            btnSpan.textContent = originalText;
            saveBtn.disabled = false;
        })
        .withFailureHandler(err => {
            showNotificationModal('Error', 'Terjadi kesalahan: ' + err.message, 'error');
            btnSpan.textContent = originalText;
            saveBtn.disabled = false;
        })
        [serverFunction](...params);
  }

  function renderSuratPage(headers, data) {
    window.suratHeaders = headers;
    const headersContainer = document.getElementById('surat-headers');
    const bodyContainer = document.getElementById('surat-body');
    const cardsContainer = document.getElementById('surat-cards');

    headersContainer.innerHTML = '';
    bodyContainer.innerHTML = '';
    cardsContainer.innerHTML = '';

    if (!headers || headers.length === 0) return;

    const columnsToShow = ['Jenis Layanan', 'Pejabat TTD'];
    let tableHeadersHtml = columnsToShow.map(header => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`).join('');
    tableHeadersHtml += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>`;
    headersContainer.innerHTML = tableHeadersHtml;
    
    if (!data || data.length === 0) {
        const colspan = columnsToShow.length + 1;
        bodyContainer.innerHTML = `<tr><td colspan="${colspan}" class="p-4 text-center text-gray-500">Tidak ada data konfigurasi surat.</td></tr>`;
        cardsContainer.innerHTML = `<div class="p-4 text-center text-gray-500">Tidak ada data.</div>`;
        return;
    }

    let allRowsHtml = '';
    let allCardsHtml = '';
    data.forEach((item, index) => {
        let rowHtml = '<tr>';
        columnsToShow.forEach(header => {
            rowHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item[header] || ''}</td>`;
        });
        
        rowHtml += `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                <button onclick='window.handleEditSuratData(${index}, ${JSON.stringify(item).replace(/'/g, "&apos;")})' class="w-8 h-8 inline-flex items-center justify-center bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200" title="Edit Data"><i class="fas fa-pencil-alt"></i></button>
                <button onclick="window.handleDeleteSuratData(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-red-100 text-red-600 rounded-md hover:bg-red-200" title="Hapus Data"><i class="fas fa-trash-alt"></i></button>
            </td>
        `;
        rowHtml += '</tr>';
        allRowsHtml += rowHtml;

        let cardHtml = `<div class="bg-white rounded-lg shadow p-4 space-y-3">`;
        columnsToShow.forEach(header => {
            cardHtml += `
                <div>
                    <p class="text-xs text-gray-500 uppercase">${header}</p>
                    <div class="text-sm font-medium text-gray-800">${item[header] || '-'}</div>
                </div>
            `;
        });
        cardHtml += `
            <div class="border-t pt-3 flex justify-end space-x-2">
                <button onclick='window.handleEditSuratData(${index}, ${JSON.stringify(item).replace(/'/g, "&apos;")})' class="w-8 h-8 inline-flex items-center justify-center bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200" title="Edit Data"><i class="fas fa-pencil-alt"></i></button>
                <button onclick="window.handleDeleteSuratData(${index})" class="w-8 h-8 inline-flex items-center justify-center bg-red-100 text-red-600 rounded-md hover:bg-red-200" title="Hapus Data"><i class="fas fa-trash-alt"></i></button>
            </div>
        `;
        cardHtml += '</div>';
        allCardsHtml += cardHtml;
    });

    bodyContainer.innerHTML = allRowsHtml;
    cardsContainer.innerHTML = allCardsHtml;
  }
  // --- END: FUNGSI-FUNGSI UNTUK HALAMAN SURAT ---

  function openProfileModal() {
    profileForm.reset();
    document.getElementById('profileErrorMessage').textContent = '';
    document.getElementById('profileErrorMessage').classList.add('hidden');
    profileModal.classList.remove('hidden');
  }
  function handleProfileSave(e) {
    e.preventDefault();
    const saveBtn = document.getElementById('saveProfileBtn');
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const errorMessage = document.getElementById('profileErrorMessage');
    if (newPassword !== confirmPassword) {
      errorMessage.textContent = 'Password baru dan konfirmasi tidak cocok.';
      errorMessage.classList.remove('hidden');
      return;
    }
   
    if (!newPassword || newPassword.length < 6) {
      errorMessage.textContent = 'Password baru minimal harus 6 karakter.';
      errorMessage.classList.remove('hidden');
      return;
    }
    errorMessage.classList.add('hidden');
    saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    saveBtn.disabled = true;
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
    if (!currentUser) return;
    
    google.script.run
      .withSuccessHandler(response => {
        if(response.success) {
          showNotificationModal('Berhasil', 'Password Anda berhasil diperbarui.', 'success');
          profileModal.classList.add('hidden');
        } else {
          errorMessage.textContent = response.message;
          errorMessage.classList.remove('hidden');
        }
        saveBtn.innerHTML = 'Simpan';
        saveBtn.disabled = false;
      })
      .withFailureHandler(err => {
        showNotificationModal('Error', 'Terjadi kesalahan: ' + err.message, 'error');
        saveBtn.innerHTML = 'Simpan';
        saveBtn.disabled = false;
      })
      .changeUserPassword(currentUser.username, oldPassword, newPassword);
  }
});
</script>


